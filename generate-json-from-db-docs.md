# データベース設計書をJSONに変換する

このプロンプトは、マークダウンで記載されたテーブル一覧とテーブル定義書をJSONに変換することを目的とする。

下記のテーブル一覧とテーブル個別定義書群を構造的なマークダウンとして解析し、JSONファイルに変換せよ。作成したJSONファイルは、AIによる自動レビューのインプットや、Prismaコード作成のためのインプットとする前提である。

## テーブル一覧の構成

テーブル一覧は、テーブルを機能コンテキストごとに纏めた1つ以上のサブセクションで構成されている。各サブセクションごとにテーブル一覧を解析せよ。

### 1. テーブル一覧のJSON変換

各サブセクションは、マークダウンの表形式で記述されている。記述内容を下記の構造を持つオブジェクトの配列に変換せよ。オブジェクトのキーは`サブセクション名`とせよ。

| 項目             | 変換後のキー名  |
| ---------------- | --------------- |
| No               | no              |
| テーブル論理名   | logicalName     |
| テーブル物理名   | physicalName    |
| ファイルパス     | path            |
| 概要             | description     |
| テーブル作成順序 | dependencyLevel |
| 備考             | note            |

- テーブル論理名は、[テーブル論理名](filepath)の形式で記載されている。下記のとおり抽出し、JSONの項目値とせよ。
  - テーブル論理名項目から、Markdownリンクの**リンクテキスト部分: [ ]内**を抽出し、logicalNameキーの値とせよ。
  - Markdownリンクの**URL部分: ( )内**を抽出し、pathキーの値とせよ。
  - 抽出できなかった場合は、それぞれ""（空文字）とせよ。

- 項目に欠落がある場合、当該項目を""(空文字)で補完し、[ERROR]としてログに記載せよ。

## テーブル定義書の構成

テーブル定義書は下記の4セクションで構成される。それぞれのセクションを分析し、記述内容をJSON形式に変換せよ。

1. テーブル概要
2. カラム定義
3. インデックス定義
4. 外部キー定義

### 1. テーブル概要のJSON変換

テーブル概要は、マークダウンの表形式(実質的に箇条書き)で記述されている。記述内容を下記のオブジェクトに変換せよ。オブジェクトのキーは`summary`とせよ。

| 項目           | 変換後のキー名 |
| -------------- | -------------- |
| テーブル論理名 | logicalName    |
| テーブル物理名 | physicalName   |
| 概要           | description    |
| カテゴリ       | category       |

「備考」欄の記載は自動レビューやPrisma変換に直接寄与しないため、取得不要である。また、上記4項目に欠落がある場合、[ERROR]としてログに記録せよ。

### 2. カラム定義のJSON変換

カラム定義は、マークダウンの表形式で記述されている。記述内容を下記の構造を持つオブジェクトの配列に変換せよ。オブジェクトのキーは`columns`とせよ。

| 項目         | 変換後のキー名 |
| ------------ | -------------- |
| カラム論理名 | logicalName    |
| カラム物理名 | physicalName   |
| 型(桁, 精度) | typeAndSize    |
| PK           | isPrimaryKey   |
| FK           | isForeignKey   |
| UK           | unique       |
| NOT NULL     | isNotNull      |
| DEFAULT      | defaultValue   |
| 備考         | note           |

- PK項目は、`PK`または`-`のどちらかが記載されている。`PK`が記載されている場合は`true`、`-`が記載されている場合は`false`とせよ。
- FK項目は、`FK`または`-`のどちらかが記載されている。`FK`が記載されている場合は`true`、`-`が記載されている場合は`false`とせよ。
- UK項目は、UKnまたは-のどちらかが記載されている。UKnが記載されている場合は、その番号を文字列として含む配列とせよ。
  - 例: `UK1` → `["UK1"]`、`UK1,UK2` → `["UK1", "UK2"]`。
  - `-`が記載されている場合は`[]`(空配列)とせよ。
- NOT NULL項目は、`NN`または`-`のどちらかが記載されている。`NN`が記載されている場合は`true`、`-`が記載されている場合は`false`とせよ。
- DEFAULT項目は、`NULL`または`-`または具体的な設定値が記載されている。`NULL`が記載されている場合は`null`、`-`が記載されている場合は""(空文字)とせよ。
  - 具体的な設定値が記載されている場合、数値・真偽値の場合はそのまま、それ以外(文字列、関数)は文字列として出力せよ。
- 備考欄は、`-`の場合は""(空文字)で、それ以外の場合は記載内容をそのまま出力せよ。
- 上記以外の項目は、記載内容のまま出力せよ。

- 項目に欠落がある場合、当該項目を""(空文字)で補完し、[ERROR]としてログに記載せよ。
- 上記の書式変換に当てはまらない場合、記載のまま出力し、[WARN]としてログに記載せよ。

### 3. インデックス定義のJSON変換

インデックス定義は、マークダウンの表形式で記述されている。記述内容を下記の構造を持つオブジェクトの配列に変換せよ。オブジェクトのキーは`indexes`とせよ。

| 項目               | 変換後のキー名     |
| ------------------ | ------------------ |
| インデックス物理名 | indexPhysicalName  |
| カラム物理名       | columnPhysicalName |
| UNIQUE             | isUnique           |
| インデックスタイプ | indexType          |
| ソート順           | sortOrder          |
| 備考               | note               |

- カラム物理名は、記載内容をカンマで分割した文字列の配列として出力せよ。カラム数が1つの場合も、配列として出力せよ。
  - 例: `name` → `["name"]`、 `user_id, service_id` → `["user_id", "service_id"]`
- UNIQUE項目は、`YES` `NO` `-`のいずれかで記載されている。`YES`は`true`、`NO`は`false`、`-`は`null`とせよ。
- ソート順は、`ASC` `DESC` `-`のいずれかが記載されている。`ASC` `DESC`の場合は記載内容をカンマで分割した文字列の配列として出力せよ。記載内容が1つの場合も、配列として出力せよ。`-`の場合は`null`とせよ。
  - 例: `ASC` → `["ASC"]`、 `ASC, DESC` → `["ASC", "DESC"]`、`-` → `null`
- 備考欄は、`-`の場合は""(空文字)で、それ以外の場合は記載内容をそのまま出力せよ。
- 上記以外の項目は、記載内容のまま出力せよ。

- 項目に欠落がある場合、当該項目を""(空文字)で補完し、[ERROR]としてログに記載せよ。
- 上記の書式変換に当てはまらない場合、記載のまま出力し、[WARN]としてログに記載せよ。

### 4. 外部キー定義のJSON変換

カラム定義は、マークダウンの表形式で記述されている。記述内容を下記の構造を持つオブジェクトの配列に変換せよ。オブジェクトのキーは`foreignKeys`とせよ。

| 項目           | 変換後のキー名           |
| -------------- | ------------------------ |
| 外部キー物理名 | foreignKeyPhysicalName   |
| 参照元カラム   | sourceColumnPhysicalName |
| 参照先テーブル | targetTablePhysicalName  |
| 参照先カラム   | targetColumnPhysicalName |
| ON DELETE      | onDelete                 |
| ON UPDATE      | onUpdate                 |
| 備考           | note                     |

- 備考欄は、`-`の場合は""(空文字)で、それ以外の場合は記載内容をそのまま出力せよ。
- それ以外の項目は、記載内容のまま出力せよ。
- 項目に欠落がある場合、当該項目を""(空文字)で補完し、[ERROR]としてログに記載せよ。

## 出力

テーブル一覧及びテーブル個別定義書群の処理結果を統合し、下記のフォーマットのJSONファイルとして出力せよ。"{}"は、取得した実際の文字列・設定値で読み替えるためのプレースホルダである。

```JSON
{
    "tableList": {
        "{サブセクション名}": 
        [
            {
                "no": "{No}",
                "logicalName": "{テーブル論理名 (リンクテキスト)}",
                "physicalName": "{テーブル物理名}",
                "path": "{ファイルパス (URL)}",
                "description": "{概要}",
                "dependencyLevel": "{テーブル作成順序}",
                "note": "{備考}"
            }
        ]
    },
    "tables": [
        {
            "summary": {
                "logicalName": "{テーブル論理名}",
                "physicalName": "{テーブル物理名}",
                "description": "{概要}",
                "category": "{系統}"
            },
            "columns": [
                {
                    "logicalName": "{カラム論理名}",
                    "physicalName": "{カラム物理名}",
                    "typeAndSize": "{型(桁数, 精度)}",
                    "isPrimaryKey": "{PK (true/false)}",
                    "isForeignKey": "{FK (true/false)}",
                    "unique": "{UKの配列 (例: [\"UK1\", \"UK2\"] または [])}",
                    "isNotNull": "{NOT NULL (true/false)}",
                    "defaultValue": "{DEFAULT (null/\"\"/設定値の文字列)}",
                    "note": "{備考 (\"\"/文字列)}"
                }
            ],
            "indexes": [
                {
                    "indexPhysicalName": "{インデックス物理名}",
                    "columnPhysicalName": "{カラム物理名の配列 (例: [\"user_id\", \"service_id\"])}",
                    "isUnique": "{UNIQUE (true/false/null)}",
                    "indexType": "{インデックスタイプ}",
                    "sortOrder": "{ソート順の配列 (例: [\"ASC\", \"DESC\"] または null)}",
                    "note": "{備考 (\"\"/文字列)}"
                }
            ],
            "foreignKeys": [
                {
                    "foreignKeyPhysicalName": "{外部キー物理名}",
                    "sourceColumnPhysicalName": "{参照元カラム物理名}",
                    "targetTablePhysicalName": "{参照先テーブル物理名}",
                    "targetColumnPhysicalName": "{参照先カラム物理名}",
                    "onDelete": "{ON DELETE}",
                    "onUpdate": "{ON UPDATE}",
                    "note": "{備考 (\"\"/文字列)}"
                }
            ]
        }
    ]
}
```

出力内容は、下記のフォーマットで返却せよ。受領側でスクリプト処理を行い、セパレーター(`------`)で分割して、そのまま計算機で処理するためのインプットとして用いる。このため、セパレーター・ファイル名・JSON・ログ以外の内容を含めてはならない。

また、ログは指摘のレベルに応じて、行頭に[ERROR]あるいは[WARN]のプレフィックスを付与せよ。

```text
------
database.json
------
JSON出力内容
------
generate.log
------
ログ内容
------
```

## データベース設計書

{TABLE_LIST}

{TABLE_DOCUMENTS}
