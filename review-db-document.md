# DB定義書を自動レビューする

このプロンプトは、Markdown方式で記述されたデータベース設計書が、設計書記述ルールを満たしているかどうかを検査するための指示書である。

下記のレビュー観点に従い、下記のDB設計書の内容をレビューし、レビュー記録票を出力せよ。

## 前提

- レビュー対象のテーブル個別定義書は、人手による2次レビューと修正を経て、AIによってPrismaコードに自動変換する。
- 自動変換したPrismaコードは、API、画面等の Source of Truth として用いる前提である。
- 確認観点に違反する項目は、「警告」「助言」の指定がない場合、すべて「エラー」として報告せよ。

## 入力

- **テーブル一覧** 本システムで提供するDBのテーブル一覧である。レビューの対象物である。
- **テーブル個別定義書** テーブルごとに作成する設計書である。レビューの対象物である。

## レビュー手順

### 1. ファイル整合性チェック

#### ファイル整合性チェックの確認観点

- テーブル一覧、テーブル個別定義書がすべて入力されていること。
- テーブル一覧がマークダウン記法で記載されていること。
- テーブル一覧の冒頭に`# テーブル一覧`が宣言されていること。
- テーブル一覧が業務コンテキストに基づいた1つ以上のサブセクションで構成されていること。
- 各サブセクションは、下記の項目を持つ表形式であること。
  - No
    - 各サブセクションで一意かつ昇順に表記されていること。違反がある場合は警告として指摘せよ。
  - テーブル論理名 (リンク)
    - ドキュメント全体で一意であること。
    - 日本語で命名されていること。但し、人手チェックとするため、違反がある場合は警告として指摘せよ。
    - 個別設計書へのリンクとして、[テーブル論理名](path)の形式であること。リンク文字列([テーブル論理名])が正しく記載され、かつ、リンクパス(path)が空欄ではないことを確認せよ。リンクが貼られていない場合は警告として指摘せよ。
    - テーブル個別定義書に存在しないテーブル名を記載している場合は警告として指摘せよ。
  - テーブル物理名
    - ドキュメント全体で一意であること。
    - snake_case形式で書かれていること。
    - テーブル論理名を英訳した英単語複数形で命名されていること。但し、人手チェックとするため、違反がある場合は警告として指摘せよ。
    - テーブル論理名が「マスタ」で終わる場合、「マスタ」を除いた英単語複数形で命名されていること(例: 組織マスタ → `organizations`)。但し、人手チェックとするため、違反がある場合は警告として指摘せよ。
    - テーブル個別定義書に存在しないテーブル名を記載している場合は警告として指摘せよ。
  - 概要
  - テーブル作成順序
    - ドキュメント全体で一意であること。
- テーブル個別定義書がマークダウン記法で記載されていること。
- テーブル個別定義書の冒頭に`# {テーブル論理名}テーブル定義`({テーブル論理名}は当該テーブルのテーブル論理名)が宣言されていること。
  - テーブル個別定義書は、テーブル一覧に記載されているテーブル論理名・物理名以外を冒頭で宣言していないことを確認せよ。
- テーブル論理名がテーブル一覧に記載されていること。
- テーブル物理名がテーブル一覧に記載されていること。対応するテーブル論理名に正しく紐づいていること。
- テーブル個別定義書に下記のセクションが存在すること。
  - テーブル概要
  - カラム定義
  - インデックス定義
  - 外部キー定義

ファイル整合性チェックで「エラー」となる指摘が発生した場合、以降のレビューを中止し、即座に結果を出力せよ。その際の後段のレビュー結果は「ファイル整合性チェックで指摘が発生したため、中止」と報告せよ。

但し、テーブル一覧が「ファイル整合性チェック」の観点上「警告」「助言」のみの指摘であり、テーブル個別定義書がプレースホルダーのままとなっている場合、テーブル一覧のレビュー指示であると解釈せよ。

「ファイル整合性チェック」で「エラー」となる指摘が発生しなかった場合、後段のレビューはすべて実施し、発生した指摘はすべて報告せよ。

### 2. DB一覧表のチェック

#### テーブル一覧の確認観点

- テーブル個別定義書の「外部キー定義」セクションに基づき、テーブル間の参照関係を抽出せよ。
- 参照元テーブルの「テーブル作成順序」が、参照先テーブルの「テーブル作成順序」より必ず大きい値であることを確認せよ。
- テーブル個別定義書が抽出できない(存在しない、またはフォーマットが不正である)場合、警告として指摘せよ。
- 別系統のテーブル群に定義されている「テーブル作成順序」と番号が10以上離れていない場合、将来のメンテナンスの便宜のため、番号のトビを設けることを助言として指摘せよ。

### 3. DB個別定義書のチェック

#### 1. 概要セクションの確認観点

- テーブル論理名が、テーブル一覧の記載と完全に一致していることを確認せよ。
- テーブル物理名が、テーブル一覧の記載と完全に一致していることを確認せよ。
- 概要が記載されていること、テーブル一覧の表記と一致していることを確認せよ。
  - 但し、概要欄はPrismaコード変換には用いないため、空欄もしくは軽微な誤謬(誤植、表記ゆれ等)である場合は警告として指摘せよ。
- テーブル論理名が、テーブル一覧において当該テーブルの所属するサブセクション名と一致していることを確認せよ。
  - 但し、概要欄はPrismaコード変換には用いないため、空欄もしくは軽微な誤謬(誤植、表記ゆれ等)である場合は警告として指摘せよ。

#### 2. カラム定義セクションの確認観点

- 下記の項目を持つ表形式で記載されていることを確認せよ。
  - カラム論理名
  - カラム物理名
  - 型
  - PK  
  - FK  
  - UNIQUE
  - NOTNULL
  - DEFAULT
  - 備考

- 下記の主キー及び監査項目が定義されており、定義(カラム論理名、カラム物理名、型、PK、FK、UNIQUE、NOTNULL、DEFAULT)が下記の通り厳密に定義されていることを確認せよ。
  - 削除フラグにUNIQUEが設定されている場合、その組み合わせがUNIQUEではない他のカラム(特にビジネスキーとなるカラム)と複合して一意性を保証していることを確認せよ。この複合条件を満たしていない場合はエラーとせよ。
  - registered_at, registered_by, updated_at, updated_by, is_deletedは、監査項目であり業務的な備考は不要であるため、備考欄は空欄(-)であることが望ましい。記載がある場合は助言として指摘せよ。

| カラム論理名 | カラム物理名 | 型          | PK  | FK  | UNIQUE | NOTNULL | DEFAULT | 備考                     |
| ------------ | ------------ | ----------- | --- | --- | ------ | ------- | ------- | ------------------------ |
| ID           | id           | VARCHAR(36) | PK  | -   | -      | NN      | UUID    | {テーブル論理名}の主キー |

| カラム論理名 | カラム物理名  | 型          | PK  | FK  | UNIQUE | NOTNULL | DEFAULT           | 備考                                       |
| ------------ | ------------- | ----------- | --- | --- | ------ | ------- | ----------------- | ------------------------------------------ |
| 登録日時     | registered_at | TIMESTAMP   | -   | -   | -      | NN      | CURRENT_TIMESTAMP | -                                          |
| 登録者       | registered_by | VARCHAR(36) | -   | -   | -      | NN      | -                 | -                                          |
| 更新日時     | updated_at    | TIMESTAMP   | -   | -   | -      | -       | NULL              | 登録時NULL、更新時は必須(ロジック側で保証) |
| 更新者       | updated_by    | VARCHAR(36) | -   | -   | -      | -       | NULL              | 登録時NULL、更新時は必須(ロジック側で保証) |
| 削除フラグ   | is_deleted    | TINYINT(1)  | -   | -   | -      | NN      | 0                 | -                                          |

- カラム論理名が、日本語で記述されていることを確認せよ。但し、人手チェックとするため、違反がある場合は警告として指摘せよ。
- カラム物理名が、監査項目(`registered_at`など)と主キー(`id`)と外部キー(`*_id`)を除き、全てカラム論理名を英訳した英単語の単数形で記述されていることを確認せよ。但し、人手チェックとするため、違反がある場合は警告として指摘せよ。
- カラム物理名が、全てsnake_case形式で記述されていることを確認せよ。
- `PK`はIDにのみ設定されていることを確認せよ。複合主キーを許容する可能性を考慮し、違反がある場合は警告として指摘せよ。
- NOTNULLが`NN`と記載されているにも関わらず、DEFAULT列が`NULL`または空欄であるカラムが存在しないことを確認せよ。
- TINYINTやBOOLEANなどの真偽値型を持つカラムが、`is_xxx`または`has_xxx`で始まり、かつNOTNULLが`NN`、DEFAULTに0または1が設定されていることを確認せよ。
- FKが設定されているカラムの論理名が、全て`{参照先テーブル論理名}ID`となっていることを確認せよ。
- FKが設定されているカラムの物理名が、全て`{参照先テーブル物理名}_id`となっていることを確認せよ。
- 外部キーを2つ以上持つテーブル(中間テーブルの可能性が高い)において、全ての外部キー項目に対してUNIQUE列に`UK1`が設定されていることを確認せよ。但し、人手チェックとするため、違反がある場合は警告として指摘せよ。
- UNIQUE列の表記が`UKn`(nはユニークキーを設定するカラムの組み合わせを識別するための通し番号。同一テーブル内で、ユニークキーを設定する組み合わせごとに一意な番号である。)であることを確認する。
- カラムのデータ型が、下記のいずれかであること、桁数・精度の指定が正しく記載されていることを確認せよ。

| 型              | 桁/精度の設定要否 | Prisma Type  | 追加の確認内容                                                                                                                                 |
| --------------- | ----------------- | ------------ | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| `VARCHAR(N)`    | 任意              | **String**   | 桁数が省略されている場合、助言として指摘せよ。但し、主キー項目、FK項目の場合は、36桁以外の場合エラーとせよ。                                   |
| `MEDIUMTEXT`    | 不可              | **String**   |                                                                                                                                                |
| `TEXT`          | 不可              | **String**   |                                                                                                                                                |
| `INTEGER`       | 不可              | **Int**      |                                                                                                                                                |
| `TINYINT`       | 不可              | **Int**      | 真偽値項目ではなく、数値として使用する場合。                                                                                                   |
| `BIGINT`        | 不可              | **BigInt**   |                                                                                                                                                |
| `REAL`          | 不可              | **Float**    | 精度が失われる可能性があるため、`DECIMAL(P, S)`に変更することを警告せよ。                                                                      |
| `FLOAT(N)`      | 不可              | **Float**    | 精度が失われる可能性があるため、`DECIMAL(P, S)`に変更することを警告せよ。                                                                      |
| `DECIMAL(P, S)` | 必須              | **Decimal**  | 桁数(`P`)が精度(`S`)以上であることを確認せよ。                                                                                                 |
| `NUMERIC(P, S)` | 必須              | **Decimal**  | 桁数(`P`)が精度(`S`)以上であることを確認せよ。                                                                                                 |
| `BOOLEAN`       | 不可              | **Boolean**  | 真偽値項目`is_xxx` `has_xxx`以外の項目に設定されている場合、警告として指摘せよ。                                                               |
| `BOOL`          | 不可              | **Boolean**  | 真偽値項目`is_xxx` `has_xxx`以外の項目に設定されている場合、警告として指摘せよ。                                                               |
| `TINYINT(1)`    | 「1」以外不可     | **Boolean**  | 真偽値項目`is_xxx` `has_xxx`以外の項目に設定されている場合、警告として指摘せよ。                                                               |
| `BIT`           | 不可              | **Boolean**  | 真偽値項目`is_xxx` `has_xxx`以外の項目に設定されている場合、警告として指摘せよ。SQL Server固有のため、設定されている場合は助言として指摘せよ。 |
| `DATE`          | 不可              | **DateTime** |                                                                                                                                                |
| `TIME`          | 不可              | **DateTime** |                                                                                                                                                |
| `TIMESTAMP`     | 不可              | **DateTime** |                                                                                                                                                |
| `DATETIME`      | 不可              | **DateTime** |                                                                                                                                                |
| `JSON`          | 不可              | **Json**     |                                                                                                                                                |
| `JSONB`         | 不可              | **Json**     |                                                                                                                                                |
| `BYTEA`         | 不可              | **Bytes**    | PostgreSQL固有のため、設定されている場合は助言として指摘せよ。                                                                                 |
| `BLOB`          | 不可              | **Bytes**    |                                                                                                                                                |
| `ENUM`          | 不可              | **Enum**     | MySQL固有のため、設定されている場合は助言として指摘せよ。                                                                                      |

#### 3. インデックス定義セクションの確認観点

- 下記の項目を持つ表形式で記載されていることを確認せよ。インデックス定義が無い場合でも、表のヘッダは必須とする。
  - インデックス物理名
  - カラム物理名
  - UNIQUE
  - インデックスタイプ  
  - ソート順  
  - 備考
- 全てのインデックス物理名が接頭辞`idx_`で始まっており、システム全体で一意であると見なせることを確認せよ。
- インデックスタイプが`B-Tree`の場合、ソート順が`ASC`または`DESC`で明記されており、`-`ではないことを確認せよ。
  - カラム物理名に複数のカラムが設定されている場合、それぞれに対して`ASC`または`DESC`が対応して設定されていることを確認せよ。(例: カラム物理名の設定が`name, email` → ソート順の設定が`ASC, DESC`など、カラム物理名のカラム個数とソート順の設定個数が一致する。)
- インデックスタイプが`Hash`の場合、ソート順が`-`であることを確認せよ。また、同じカラムセットに対し`B-Tree`インデックスが重複して定義されていないことを確認せよ。
- 外部キー (`FK`設定カラム) が、JOIN処理の効率化のため、複合インデックスの一部として含まれる場合を含め、`B-Tree`インデックスとして定義されていることを確認せよ。但し、RDBMSの自動作成を考慮し、未定義の場合は警告とする。
- カラム定義セクションで複合UNIQUEキーが設定されている場合、その複合キーが、`B-Tree`インデックスとして定義されていることを確認せよ。
  - 但し、RDBMSの自動作成を考慮し、未定義の場合は警告とする。
- `PK`が設定されている項目を、インデックスとして重複定義していないことを確認せよ。
- name、email、urlといった、検索項目として指定されることが示唆される項目にインデックスが定義されていない場合、助言として指摘せよ。

#### 4. 外部キー定義セクションの確認観点

- 下記の項目を持つ表形式で記載されていることを確認せよ。外部キー定義が無い場合でも、表のヘッダは必須とする。
  - 外部キー物理名  
  - 参照元カラム物理名
  - 参照先テーブル物理名
  - 参照先カラム物理名  
  - ON DELETE
  - ON UPDATE  
  - 備考
- 全ての外部キー物理名が接頭辞`fk_`で始まっており、システム全体で一意であると見なせることを確認せよ。
- 「カラム定義」でFKが設定されているカラムが、全て「外部キー定義」テーブルに記載されていることを確認せよ。
- 「参照先カラム物理名」の記載が「`id`」であることを確認せよ。人手チェックとするため、違反がある場合は警告として指摘せよ。
- 参照先テーブル物理名が「テーブル一覧」に存在することを確認せよ。
- 参照先テーブル物理名が、「テーブル個別定義書」のファイル名と一致することを確認せよ。
- ON DELETEとON UPDATEが、`Cascade`、`Restrict`、`NoAction`、`SetNull`、`SetDefault`のいずれかで明記されていることを確認せよ。

## 出力形式

以上のレビューで抽出した指摘を、設計書ごとに下記のフォーマットで出力せよ。受領側でスクリプト処理を行い、セパレーター(`------`)で分割して、そのままレビュー記録票として用いる。このため、セパレーター・ファイル名・指摘内容以外の内容を含めてはならない。「レビュワー確認事項」セクションはヒューマンチェック結果を記載する想定のため、セクション名と定型メッセージのみ出力せよ。

フォーマット内の下記のプレースホルダーは、下記のとおり実際の項目名に読み替えよ。

- **{テーブル論理名}** レビュー対象としたテーブル定義書のテーブル論理名。テーブル一覧の場合は「テーブル一覧」。
- **{テーブル物理名}** レビュー対象としたテーブル定義書のテーブル物理名。テーブル一覧の場合は「tables」。
- **{レビュー日時}** レビューを実施した日時を、日本時間の`YYYY/MM/DD HH:mm:SS`形式で表記する。
- **{NO}** 各セクションごとに纏めた指摘一覧の通し番号。セクションごとに1オリジンで採番せよ。
- **{指摘結果}** 下記のいずれかを表記する。
  - **-** ファイル整合性チェック違反のためレビューを中止した項目である場合。
  - **エラー** レビュー観点に明確に違反しており、修正が必須である場合。
  - **警告** レビュー観点で「警告として指摘せよ」としているチェック項目に違反している場合。
  - **OK** レビュー観点違反が検出されなかった場合。
  - **助言** レビュー観点違反は検出されなかったが、改善の余地がある場合。(例: 電話/電話番号 の表記ゆれ等)
- **{項目名}** 検査対象としたDB項目の名称。
- **{指摘内容}** 検査対象とした項目への、短い文章による指摘。(例: 「指摘なし」「設定されていません」「項目に定義可能な型ではありません」「参照先のテーブルが定義されていません」など)
- **{自由記述}** 当該指摘項目に対する、文章による自由記述形式の備考。修正方針に対する助言等。
- **{レビュワー確認}** ヒューマンフィードバックのテンプレートとして、「指摘結果」に応じて下記のいずれかを表記する。
  - **エラー** 「修正してください」と表記する。
  - **警告** 「**■検討結果を記載してください■**」と表記する。
  - **OK** 「-」と表記する。
  - **助言** 「**■検討結果を記載してください■**」と表記する。

以下のセクションは、レビュー対象の設計書に合わせて出力を調整せよ。

- **### テーブル一覧** テーブル個別定義書のレビュー結果の場合、当該テーブルに関する内容のみ記載する。
- **### テーブル個別定義書** テーブル一覧のレビュー結果の場合、省略する。
- **## 2. テーブル一覧チェック結果** テーブル個別定義書のレビュー結果の場合、当該テーブルに関する内容のみ記載する。
- **## 3. テーブル個別定義書チェック結果** テーブル一覧のレビュー結果の場合、省略する。

```text
{テーブル物理名}_review.md
------
# {テーブル論理名}設計書レビュー記録票

- レビュー日時 {レビュー日時}

## 1. ファイル整合性チェック結果

### テーブル一覧

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

### テーブル個別定義書

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

## 2. テーブル一覧チェック結果

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

## 3. テーブル個別定義書チェック結果

### 1. 概要セクションチェック結果

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

### 2. カラム定義セクションチェック結果

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

### 3. インデックス定義セクションチェック結果

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

### 4. 外部キー定義セクションチェック結果

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

## レビュワー確認事項

**必ず記入してレビュー記録票として提出してください。**
------
```

## テーブル一覧

{TableListHere}

## テーブル個別定義書

{TableDocumentsHere}
