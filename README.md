# scms-prompt: AIガバナンスとコード自動生成のためのプロンプト集

本作品群は、[simple-contract-management-system](https://github.com/ryo-ichikawa-0308/simple-contract-management-system)において、AIガバナンスを行う、あるいはAIでコードを自動生成する際に用いるプロンプトである。これらのプロンプトをCI過程に組み込むことで、DevOpsにおける効率化と品質向上を目指す。

* **AIガバナンス:** 設計書とコードの一貫性をAIがチェックすることで、手動レビューで発生しがちなミスを防ぎ、設計変更への追従を容易にする。
* **コード自動生成:** 手作業によるコード記述を削減し、開発速度と品質を両立する。

## プロンプト一覧

このプロンプト群は、DB設計からAPI実装までを段階的に自動化・検証するよう設計されている。

### 1. DB設計書処理フェーズ

| ファイル名                                                           | 概要                                       | 目的・用途                                                                                          |
| -------------------------------------------------------------------- | ------------------------------------------ | --------------------------------------------------------------------------------------------------- |
| [generate-json-from-db-docs.md](./generate-json-from-db-docs.md)     | DB設計書をJSON形式に変換                   | 後続の自動レビュープロンプトの入力データを作成する。                                  |
| [review-db-json.md](./review-db-json.md)                             | DB設計書(JSON版)の自動レビュー             | 業務的な要件が人手で確認済みであることを前提に、記述形式や一貫性をチェックする。                    |
| [generate-prisma-from-db-json.md](./generate-prisma-from-db-json.md) | DB設計書(JSON版)からPrismaコードを自動生成 | Prismaコードを自動生成し、API設計書のレビューやAPI実装の**正となる情報源(Source of Truth)**とする。 |

### 2. API設計書処理フェーズ

| ファイル名                                                         | 概要                            | 目的・用途                                                                                                                              |
| ------------------------------------------------------------------ | ------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| [generate-json-from-api-docs.md](./generate-json-from-api-docs.md) | API設計書をJSON形式に変換       | 後続の自動レビュープロンプトの入力データを作成する。                                                                                    |
| [review-api-json.md](./review-api-json.md)                         | API設計書(JSON版)の自動レビュー | PrismaコードがSource of Truthとして作成されていることを前提に、DB定義との整合性をチェック。業務要件の確認は人手によることを前提とする。 |

### 3. 実装・スケルトン生成フェーズ

| ファイル名                                                       | 概要                                                                  | 目的・用途                                                                                                                                 |
| ---------------------------------------------------------------- | --------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| [generate-dao-dto.md](./generate-dao-dto.md)                     | PrismaコードからDAO層のコードとテーブルDTOを自動生成                  | 生成AIのAPIレスポンスをスクリプトで解析し、実コードに分離・出力することで、DB定義に忠実なDAO/DTOを作成する。                               |
| [generate-api-from-api-docs.md](./generate-api-from-api-docs.md) | API設計書(JSON版)からController/Service層のスケルトンコードを自動生成 | 生成AIのAPIレスポンスをスクリプトで解析し、実コードに分離・出力することで、API定義に沿ったController/Service層のコードを効率的に作成する。 |

## プロンプト一覧(旧作: JSON化前のプロトタイプ)

Markdownを直接レビューする想定で作成した旧版のプロンプト。MarkdownをJSON化して構造的な比較を行う「JSON化して突き合わせる」手法の方が正確性を期待できるため、下記の作品はアイディアに至る経緯を示すものとして残す。

* **[review-db-document.md](./old/review-db-document.md)** DB設計書を自動レビューするためのプロンプト。業務的な要件は人手で確認されていることが前提である。
* **[generate-prisma-code.md](./old/generate-prisma-code.md)** DB設計書からPrismaコードを自動生成するプロンプト。Pythonなどのスクリプトから生成AIのAPIに送信し、そのレスポンスをスクリプト側で解析して実コードに分離することを想定している。
* **[review-api-document.md](./old/review-api-document.md)** API設計書を自動レビューするためのプロンプト。DB設計書に忠実に実装されたPrismaコードが存在することが前提である。

## スクリプト

* **[gemini_script](./gemini_script/)** 上記のプロンプトをGeminiで動作確認するためのスクリプト(簡易版)。

APIキーを設定したファイル`api.ini`が必要です。手動で下記の内容のファイルを作成してください。

```ini
[GEMINI]
API_KEY=YOUR_GEMINI_API_KEY
```

## その他

### 運用設計に関する留意事項

著者の作業環境(無料版Gemini)では、プロンプトファイルと処理対象ファイルを別々にアップロードし、「xxxxxx.mdの指示通りにxxxxxx.mdを処理し、結果を出力せよ。」といったプロンプトを与えることで安定した出力が得られた。
これは、プロンプトファイルと処理対象ファイルをまとめてプロンプトとして投入すると、処理可能なトークン制限により結果が不安定になるが、別ファイルとすることでこれを回避できるためと考えられる。

したがって、実際のCI運用においては、「プロンプトファイルをサーバー上に格納し、CIパイプライン側で対象ファイルの内容とプロンプトファイルを結合して単一のAPIコールとして送信する」といった、安定性を担保した設計を推奨する。

### コード生成プロンプトの著者環境での実証結果

| プロンプト        | 作成精度 | 備考                                                                                                                                                                                     |
| ----------------- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| DB設計書JSON変換  | A+       | デフォルト値`null`の場合に"null"と文字列表記するといった小さい変換ミス(指摘して再出力させると解消)。それ以外は正確に変換された。                                                         |
| Prismaコード作成  | S        | DBのスキーマ定義としてそのまま使用可能。                                                                                                                                                 |
| DAO/DTOコード生成 | B+       | テストコードに若干の手動での調整を必要とした。                                                                                                                                           |
| API設計書JSON変換 | A+       | エンドポイントからベースパスを除去して別要素にまとめる処理の欠落(指摘して再出力させると解消)。それ以外は正確に変換された。                                                               |
| APIコード生成     | C+       | エンドポイントのコントローラーコードはほぼ正確。ビジネスロジックは呼び出し関係のみのスケルトンコードとしたが、正確に実装された。テストコードの自動実装部分は、手動での調整を必要とした。 |

#### 考察

* **JSONコード変換(A+評価):** 変換ミスは指摘により修正可能な範囲であり、スクリプト側で変換後のJSONの構文チェックと簡単なスキーマバリデーションを設けることで、手修正の必要性をほぼ排除できると評価できる。
* **コード生成の課題(B+、C+評価):**
  * **テストコードの調整:** テンプレートを精緻化することで改善が期待できる。ESLintのエラー対応(`any`型や`unsafe`入出力)は、ガバナンス上、LLMに修正を強いるよりも、人手または別の静的解析プロセスでの対応を前提とする方が現実的と思料する。
  * **APIコード生成の精度(C+):** コントローラーは定形だが、サービス層のビジネスロジックは多岐にわたるため、意図的にスケルトンに留めるという判断は、LLMの限界を考慮すると妥当と思料する。型名や呼び出し方法は設計通り出力されたので、Github copilotのような実装に特化したAIとの併用も効果が期待できると思料する。
* **AI環境の安定性:** 著者検証環境(無料版Geminiにファイルアップロードして、プロンプトで処理指示)では、インプットファイルの修正&再アップロードをすると出力が不安定化する傾向が見られた。これは再アップロードによってインプットファイルが多重化し、AIのコンテキストが混乱したことによるものと推測される。CI運用においては、APIコールのたびにあるべきインプットファイルのみが送られる想定のため、問題にはならないと思料する。

(C)2025 Ryo ICHIKAWA
