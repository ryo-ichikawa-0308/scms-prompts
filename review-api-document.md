# Prismaモデルコードを元にAPI設計書をレビューする

このプロンプトは、Prismaコードの内容に基づいてAPI設計書の内容をレビューするための手順書である。

下記のPrismaコードをもとに、下記のAPI設計書の内容をレビューし、レビュー記録票を出力せよ。

## 前提

- Prismaモデルコードは、DB設計書に忠実に作成されており、モデル名、カラム名にはPrismaコメントで適切に論理名が付与されている。
- 原則として、DB設計書を正とする。
- 確認観点に違反する項目は、「警告」「助言」の指定がない場合、すべて「エラー」として報告せよ。」

## 入力

- **Prismaコード** 本システムで使用するDBスキーマのPrismaコードである。
- **API一覧** 本システムで提供するAPIの一覧である。レビューの対象物である。
- **API個別定義書** APIごとに作成する設計書である。レビューの対象物である。

## レビュー手順

### 1. ファイル整合性チェック

#### ファイル整合性チェックの確認観点

- Prismaコード、API一覧、API個別定義書がすべて入力されていること。
  - Prismaコードは、Prismaモデル形式に従って記述されており、すべてのモデル名、カラム名にPrismaコメントで論理名が付与されていること。
  - モデル物理名はPascalCase、カラム物理名はcamelCaseで記載されていること。
  - リレーションフィールド、逆リレーションフィールドは論理名不要である。

- API一覧がマークダウン記法で記載されていること。
- API一覧に下記のセクションが存在すること。
  - API一覧
  - API一覧はマークダウンの表形式で記載されており、以下の項目で構成されていること。
    - No(API一覧全体で一意であること。番号のトビは許容する。)
    - API名
      - 個別設計書へのリンクとして、[API名](path)の形式であること。リンク文字列([API名])が正しく記載され、かつ、リンクパス(path)が空欄ではないことを確認せよ。リンクが貼られていない場合は警告として指摘せよ。
    - エンドポイント
    - メソッド
    - 系統
    - 認証要否
    - 備考

- API個別定義書がマークダウン記法で記載されていること。
- API名がAPI一覧に記載されていること。
- API個別定義書に下記のセクションが存在すること。
  - API名
    - API一覧の「API名」と一致していること
  - エンドポイント  
    - API一覧の「エンドポイント」と一致していること
  - 認証要否
    - API一覧の「認証要否」と一致していること
  - メソッド
    - API一覧の「メソッド」と一致していること
  - データ形式
  - リクエストヘッダ
    - 認証「要」の場合、`Authorization` が定義されていること
    - `Content-Type`が定義されていること
  - リクエスト
  - 処理概要
    - 機能定義書へのリンク([機能名](path)の形式)、もしくは100文字程度の簡潔な処理概要が記載されていること。
    - API定義書はあくまでエンドポイントの仕様を定義するため、100文字程度を超える詳細な処理が記述されている場合(特に、トランザクション内部の詳細な処理について言及されている場合)は「助言」として指摘せよ。
  - レスポンス
  - エラー定義

ファイル整合性チェックで「エラー」となる指摘が発生した場合、以降のレビューを中止し、即座に結果を出力せよ。その際の後段のレビュー結果は「ファイル整合性チェックで指摘が発生したため、中止」と報告せよ。

但し、PrismaコードとAPI一覧が「ファイル整合性チェック」の観点上問題なく入力されており、API個別定義書がプレースホルダーのままとなっている場合、API一覧のレビュー指示であると解釈せよ。

「ファイル整合性チェック」で「エラー」となる指摘が発生しなかった場合、後段のレビューはすべて実施し、発生した指摘はすべて報告せよ。

### 2. ルーティングと命名規則チェック

#### ルーティングとメソッドの適合性チェック

##### エンドポイント構造の検証

- API一覧のエンドポイントが、基本構造(`/api/v1/{リソース名}/<アクション>`)に従っていること。
  - {リソース名}は対応するPrismaモデル物理名をsnake_case変換したものと一致していること。(例: UserServices → user_services)
  - {リソース名}がPrismaモデルに存在しない場合、人手チェックするため警告として指摘せよ。(例: auth、emailなど)

- 取得系APIのメソッド検証:
  - API一覧の系統が「取得」である場合、日本のエンタプライズ系システムの慣習に合わせるため、メソッドは原則POSTであること。GETの場合、人手チェックとするため警告として指摘せよ。

- 登録/更新/削除APIのメソッド検証:
  - エンドポイントのアクションがcreateの場合、メソッドはPOSTであること。
  - エンドポイントのアクションがupdateの場合、メソッドはPUTまたはPATCHであること。
  - エンドポイントのアクションがdeleteの場合、メソッドはDELETEであること。

- 認証要否の検証:
  - API一覧の認証要否が「不要」と設定できるのは、以下のいずれかの**処理**に該当するAPIに限定すること。
    - **認証情報取得・設定処理**：
      - ログイン (`/api/v1/auth/signin`)
      - ログアウト (`/api/v1/auth/logout`)
      - パスワードリセットや認証情報の初期化など、未認証状態で実行される認証関連アクション
    - **ユーザー登録処理 (サインアップ)**：
      - 新規登録 (`/api/v1/signup/register`)
  - **上記以外のAPI**で認証要否が「不要」となっている場合、セキュリティ上の問題として**エラー**を指摘せよ。

##### 命名規則の整合性チェック

- API項目名の検証:
  - API個別定義書内のリクエストおよびレスポンスセクションに記載されている物理名は、すべてcamelCase形式であること。

- DB項目との紐づけ検証:
  - リクエストおよびレスポンスセクションに記載されている物理名は、DBテーブルおよびDBカラムが指定されている場合、対応するPrismaモデルのカラム物理名と一致していること。

### 3. リクエストパラメータの詳細チェック

#### 禁止項目

- 認証トークンはリクエストヘッダに含めるため、リクエストパラメータに含めてはならない。

#### ルートオブジェクト/子オブジェクトのセクションチェック

- ルートオブジェクトに`array` `object`型の項目を含む場合、そこにネストされる子オブジェクトの定義を必須とする。
- 子オブジェクトのセクション名は、親オブジェクトより1段進んだ見出しで記載されており、論理名と一致していること。

#### 項目詳細チェック(ルートオブジェクト/子オブジェクト共通)

下記の項目が、以下のルールに従って記載されていることを確認する。

- 論理名/物理名
  - 記載されていること
- 型
  - 記載されていること
  - `string` `number` `date` `object` `array` のいずれかであること。
  - 登録系、更新系、削除系の場合かつDBの紐づき先がある場合、対応するカラムの型と一致していること。
- DBテーブル/DBカラム
  - DBテーブルはPrismaコードのテーブル論理名に存在すること。
  - DBテーブルに記載がある場合、DBカラムは当該テーブルのカラム論理名に存在すること。
  - DBテーブルの記載が「-」の場合、DBカラムの記載は「-」であること。
- 必須
  - 「必須」「任意」のどちらかであること。
- 最小桁数
  - 型が`string`の場合、0以上(必須の場合は1以上)の整数であること。
  - それ以外の場合、「-」であること。
- 最大桁数
  - 型が`string`の場合、「最小桁数」以上の整数であること。
  - それ以外の場合、「-」であること。
- フォーマット
  - 記載がある、もしくは「-」であること。
  - 型が`number`かつ対応するDB項目が`Decimal`型の場合、`P,S`のフォーマットで桁数`P`と精度`S`が定義されていること。
    - その際、精度`S`の値が桁数`P`以下であること。
  - 型が`string`かつ対応するDB項目が`string`型の場合、かつ「email」「tel」「fax」「zip」「url」といった特定のフォーマットを示唆する項目名の場合、対応するフォーマット名(「メールアドレス」「電話番号」など)が記載されていること。但し、最終的に人手チェックとするため、警告として指摘せよ。
- 最小値
  - 「型」が`number`の場合、数値型で記載されていること。
  - 「型」が`array`の場合、0以上の整数で記載されていること。
    - 但し、「必須」の記載内容が「必須」の場合、1以上の整数で記載されていること。
- 最大値
  - 「型」が`number`の場合、数値型で記載されていること。また、「最小値」以上であること。
  - 「型」が`array`の場合、0以上の整数で記載されていること。また、「最小値」以上であること。
- 備考
  - 自由記述欄のためチェック無し。

#### 系統が「取得」の場合の個別チェック

- リクエストに下記の監査項目を含めてはならない。
  - **登録者** `registeredBy`
  - **登録日時** `registeredAt`
  - **更新者** `updatedBy`
  - **更新日時** `updatedAt`
  - **削除フラグ** `isDeleted`

- あいまい検索の対象とするため、DBカラムの型が`number` `Date`の場合でもリクエスト側の項目を`string`型で定義することを許容する。但し、人手でチェックするため、警告として指摘せよ。

#### 系統が「登録」の場合の個別チェック

- リクエストに「ID」(登録対象のテーブルの主キー)を含めてはならない。

- リクエストに下記の監査項目を含めてはならない。
  - **登録者** `registeredBy`
  - **登録日時** `registeredAt`
  - **更新者** `updatedBy`
  - **更新日時** `updatedAt`
  - **削除フラグ** `isDeleted`

- 親子関係の登録検証:
  - 親子関係を持つリソースを対象としている場合、親リソースのリクエストボディに、子リソースの配列(`array`型)が、DBテーブル/DBカラムが「-」の項目として含まれていること。
  - 親リソースとなるオブジェクトがDBテーブルに紐づいている場合、親テーブルに紐づくPrismaのリレーションフィールドに小リソースとなるモデルが定義されていること。但し、要件上の都合であえて外部キーを定義していない場合を考慮し、人手チェックとするため警告として指摘せよ。

#### 系統が「更新」の場合の個別チェック

- 「ルートオブジェクト」及び子項目のレコードに「ID」(更新対象のテーブルの主キー)を必須とする。

- リクエストに下記の監査項目を含めてはならない。
  - **登録者** `registeredBy`
  - **登録日時** `registeredAt`
  - **更新者** `updatedBy`
  - **更新日時** `updatedAt`

- リクエストに「削除フラグ」`isDeleted`を含む場合、PATCHによる論理削除の可能性を考慮し、人手チェックとするため警告として指摘せよ。

- メソッドがPUTである場合、対応するPrismaモデルの、監査項目を除くすべてのフィールドが必須または任意として定義されていること。

#### 系統が「削除」の場合の個別チェック

- レコードが「ID」(削除対象のテーブルの主キー)のみであること。

### 4. レスポンスとエラー定義チェック

#### 成功時レスポンスコードの検証

- **取得系:** 200 OKが定義されていること。
- **登録系:** 201 CREATEDが定義されていること。
- **更新/削除系:** 204 NO CONTENTが定義されていること。

- 項目詳細チェック:
  - レスポンスセクションのルートオブジェクトおよび子オブジェクトについて、セクション3の「項目詳細チェック」と同様の検証ルールを適用すること。
  - **取得系:** 取得したデータをレスポンスとしていること。
    - アクションが`list`の場合、ルートオブジェクトの項目は対象とするリソースの`array`であること。それ以外の項目を含む場合、人手チェックとするため警告として指摘せよ。
    - アクションが`detail`の場合、ルートオブジェクトは対象とするリソースの単一オブジェクトであること。それ以外の項目を含む場合、人手チェックとするため警告として指摘せよ。
  - **登録系:** ID(登録したレコードの主キー)のみをレスポンスとしていること。
  - **更新/削除系:** 「なし」となっていること。

#### エラー定義のチェック

- 必須エラーの検証: API個別定義書のエラー定義に、以下のHTTPステータスコードが定義されていること。
  - 400 BAD REQUEST
  - 401 UNAUTHORIZED
  - 500 INTERNAL SERVER ERROR
  - 取得系の場合: 404 NOT FOUND
  - 登録系の場合: 409 CONFLICT

- 共通フォーマットの検証: すべてのエラーレスポンスが、共通JSONフォーマット(message, details)に従っていること。

## 出力形式

以上のレビューで抽出した指摘を下記のフォーマットで出力せよ。受領側でスクリプト処理を行い、セパレーター(`------`)で分割して、そのままレビュー記録票として用いる。このため、セパレーター・ファイル名・指摘内容以外の内容を含めてはならない。「レビュワー確認事項」セクションはヒューマンチェック結果を記載する想定のため、セクション名と定型メッセージのみ出力せよ。

フォーマット内の下記のプレースホルダーは、下記のとおり実際の項目名に読み替えよ。

- **{API名}** レビュー対象としたAPIの名称
- **{レビュー日時}** レビューを実施した日時を、日本時間の`YYYY/MM/DD HH:mm:SS`形式で表記する。
- **{NO}** 各セクションごとに纏めた指摘一覧の通し番号。セクションごとに1オリジンで採番せよ。
- **{指摘結果}** 下記のいずれかを表記する。
  - **-** ファイル整合性チェック違反のためレビューを中止した項目である場合。
  - **エラー** レビュー観点に明確に違反しており、修正が必須である場合。
  - **警告** レビュー観点で「警告として指摘せよ」としているチェック項目に違反している場合。
  - **OK** レビュー観点違反が検出されなかった場合。
  - **助言** レビュー観点違反は検出されなかったが、改善の余地がある場合。(例: 電話/電話番号 の表記ゆれ等)
- **{項目名}** 検査対象としたAPI項目の名称。
- **{指摘内容}** 検査対象とした項目への、短い文章による指摘。(例: 「指摘なし」「設定されていません」「DBの型と異なります」「DB桁数を超えています」など)
- **{自由記述}** 当該指摘項目に対する、文章による自由記述形式の備考。修正方針に対する助言等。
- **{レビュワー確認}** ヒューマンフィードバックのテンプレートとして、「指摘結果」に応じて下記のいずれかを表記する。
  - **エラー** 「修正してください」と表記する。
  - **警告** 「**■検討結果を記載してください■**」と表記する。
  - **OK** 「-」と表記する。
  - **助言** 「**■検討結果を記載してください■**」と表記する。

```text
{API名}_review.md
------
# {API名}設計書レビュー記録票

- レビュー日時 {レビュー日時}

## 1. ファイル整合性チェック結果

### Prismaコード

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

### API一覧

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

### API個別定義書

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

## 2. ルーティングと命名規則チェック結果

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

## 3. リクエストパラメータの詳細チェック結果

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

## 4. レスポンスとエラー定義チェック結果

| No   | 項目名   | 指摘結果   | 指摘内容   | 備考       | レビュワー確認   |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

## レビュワー確認事項

**必ず記入してレビュー記録票として提出してください。**
------
```

## Prismaコード

(PrismaCodeHere)

## API一覧

(ApiListHere)

## API個別定義書

(ApiDocumentsHere)
