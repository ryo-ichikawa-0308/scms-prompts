# DB 定義書を自動レビューする

このプロンプトは、JSON 形式に変換されたデータベース設計書が、設計書記述ルールを満たしているかどうかを検査するための指示書である。

下記のレビュー観点に従い、下記の JSON データの内容をレビューし、レビュー記録票を出力せよ。

## 前提

- レビュー対象のテーブル個別定義書は、人手による 2 次レビューと修正を経て、AI によって Prisma コードに自動変換する。
- 自動変換した Prisma コードは、API、画面等の Source of Truth として用いる前提である。
- 確認観点に違反する項目は、「警告」「助言」の指定がない場合、すべて「エラー」として報告せよ。

## JSON 入力構造

入力は、下記の構造を持つ JSON データである。

```JSON
{
    "tableList": {
        "{サブセクション名}": [
            {
               "no": "...",
                "logicalName": "...",
                "physicalName": "...",
                "path": "...",
                "description": "...",
                "dependencyLevel": "...",  /* テーブル作成順序のキー */
                "note": "..."
            }
        ]
    },
    "tables": [
        {
            "summary": { /* テーブル概要のキー */
                "logicalName": "...",
                "physicalName": "...",
                "description": "...",
                "category": "..."
            },
            "columns": [ ... ],
            "indexes": [ ... ],
            "foreignKeys": [ ... ]
        }
    ]
}
```

## レビュー手順

### 1. JSON 構造とデータ整合性チェック

#### JSON 構造とデータ整合性チェックの確認観点

- 入力全体が有効な JSON 形式であること。
- ルートに `tableList` (オブジェクト) と `tables` (配列) が存在すること。
- `tableList` 内の全てのテーブルエントリ(サブセクション内の各オブジェクト)が、下記の必須キーを持ち、値が空でないこと。
- `logicalName`, `physicalName`, `dependencyLevel`
- `tableList` に含まれる全テーブル数と、`tables` 配列に含まれるテーブルオブジェクトの数が一致すること。過不足がある場合は個別設計未了もしくは一覧反映未済の可能性を考慮し、警告として指摘せよ。
- `tables` 配列内の各テーブルオブジェクトが、`summary`, `columns`, `indexes`, `foreignKeys` の 4 つのトップレベルキーを厳密に持っていること。
- `tables[i].summary` オブジェクトが `logicalName`, `physicalName`, `description`, `category` の 4 つのキーを持っていること。

JSON 構造とデータ整合性チェックで「エラー」となる指摘が発生した場合、以降のレビューを中止し、即座に結果を出力せよ。その際の後段のレビュー結果は「JSON 構造とデータ整合性チェックで指摘が発生したため、中止」と報告せよ。

### 2. DB 一覧表のチェック

#### テーブル一覧の確認観点

- **一意性:** `tableList` に含まれる全テーブルについて、`logicalName`、`physicalName`、`dependencyLevel` がドキュメント全体で一意であることを確認せよ。
- **ナンバリング:** `tableList` の各サブセクション内で、`no` が一意かつ昇順に表記されていることを確認せよ。違反がある場合は警告として指摘せよ。
- **命名規則(テーブル物理名):**
  - 全ての `physicalName` が snake_case 形式で書かれていることを確認せよ。
  - 全ての `physicalName` が、対応する`logicalName`を英訳した英単語の複数形になっているかを厳格に判断せよ。わずかでも疑問がある場合は警告として指摘せよ。(例: ユーザー → users)。
- **リンク整合性:** `tableList` の各エントリの `path` フィールドが空欄ではないことを確認せよ。空欄の場合は警告として指摘せよ。
- **クロス整合性:**
  - `tableList` に記載されている全ての `physicalName` が、`tables` 配列内のいずれかのテーブルオブジェクトの `summary.physicalName` と正確に対応していることを確認せよ。
  - `tableList` に記載されている全ての `logicalName` が、`tables` 配列内のいずれかのテーブルオブジェクトの `summary.logicalName` と正確に対応していることを確認せよ。
- **依存レベル（テーブル作成順序）:** `tables` 配列内の各テーブルの `foreignKeys` 定義に基づき、テーブル間の参照関係を抽出せよ。
  - 参照元テーブルの `dependencyLevel` が、参照先テーブルの `dependencyLevel` より必ず大きい値（作成順序が後）であることを確認せよ。
  - 依存レベルのトビ（助言）: 別系統のテーブル群に定義されている `dependencyLevel` と番号が 10 以上離れていない場合、将来のメンテナンスの便宜のため、番号のトビを設けることを助言として指摘せよ。テーブルの系統は、`tableList`の{サブセクション名}（カテゴリ）を参考に判断せよ

### 3. DB 個別定義書のチェック

以降のレビューは、`tables` 配列内の各テーブルオブジェクト（`tables[i]`）を個別に実施する。

#### 1. 概要セクションの確認観点 (summary)

- **論理名/物理名の整合性:**

  - `summary.logicalName` が、`tableList` の対応するエントリの `logicalName` と完全に一致していることを確認せよ。
  - `summary.physicalName` が、`tableList` の対応するエントリの `physicalName` と完全に一致していることを確認せよ。

- **概要/カテゴリの整合性（警告/助言）:**
  - `summary.description` が、 `tableList` の対応するエントリの `description` と一致していることを確認せよ。不一致や空欄の場合は警告として指摘せよ。
  - `summary.category` が、`tableList` において当該テーブルが所属するサブセクション名と一致していることを確認せよ。不一致や空欄の場合は警告として指摘せよ。

#### 2. カラム定義セクションの確認観点 (columns)

- **主キー (id) の厳密な定義チェック:**

  - `physicalName`: "id"かつ`logicalName`: "ID" のカラムが 1 つだけ存在すること。
  - その定義が下記の通り厳密に一致すること。
    - `isPrimaryKey`: true
    - `isForeignKey`: false
    - `typeAndSize`: "VARCHAR(36)"
    - `unique`: []
    - `isNotNull`: true
    - `defaultValue`: "UUID"

- **監査項目 (registered_at など) の厳密な定義チェック:**
  - 以下の 5 つの監査カラムが全て存在し、その定義が下記の表と厳密に一致することを確認せよ。
  - is_deleted に unique: ["UKn"] が設定されている場合、その組み合わせが UNIQUE ではない他のカラム(特にビジネスキーとなるカラム)と複合して一意性を保証していることを確認せよ。この複合条件を満たしていない場合はエラーとせよ。
  - registered_at, registered_by, updated_at, updated_by, is_deleted の note 欄が空欄 "" であることが望ましい。記載がある場合は助言として指摘せよ。

| physicalName  | logicalName | typeAndSize | isPrimaryKey | isForeignKey | unique | isNotNull | defaultValue        | note                                        |
| ------------- | ----------- | ----------- | ------------ | ------------ | ------ | --------- | ------------------- | ------------------------------------------- |
| registered_at | 登録日時    | TIMESTAMP   | false        | false        | []     | true      | "CURRENT_TIMESTAMP" | ""                                          |
| registered_by | 登録者      | VARCHAR(36) | false        | false        | []     | true      | ""                  | ""                                          |
| updated_at    | 更新日時    | TIMESTAMP   | false        | false        | []     | false     | null                | 登録時 NULL、更新時は必須(ロジック側で保証) |
| updated_by    | 更新者      | VARCHAR(36) | false        | false        | []     | false     | null                | 登録時 NULL、更新時は必須(ロジック側で保証) |
| is_deleted    | 削除フラグ  | TINYINT(1)  | false        | false        | []     | true      | 0                   | ""                                          |

- **命名規則（カラム）:**

  - `physicalName` が全て`snake_case`形式で記述されていることを確認せよ。
  - `physicalName` が全て`logicalName`の内容を英訳した英単語の単数形になっているかを厳格に判断せよ。わずかでも疑問がある場合は警告として指摘せよ。
  - `isForeignKey`: `true` のカラムの `physicalName` が、全て`{参照先テーブル物理名}_id`となっていることを確認せよ。
  - `isForeignKey`: `true` のカラムの `logicalName` が、全て`{参照先テーブル論理名}ID`となっていることを確認せよ。

- **制約整合性:**

  - `isNotNull`: `true` にも関わらず、`defaultValue` が `null` または "" のカラムが存在しないことを確認せよ。
  - `physicalName` が `is_xxx` または `has_xxx` で始まるカラムについて、`typeAndSize` が真偽値型（`TINYINT(1)`, `BOOLEAN`, `BOOL`, `BIT`）であり、かつ `isNotNull`: `true`、`defaultValue` に `0` または `1` / `false` または `true` が設定されていることを確認せよ。

- **中間テーブルの UNIQUE キー:** 外部キーを 2 つ以上持つテーブル（中間テーブルの可能性が高い）において、全ての外部キー項目（`isForeignKey`: `true` のカラム）に対して、`unique` 列に同じ`UKn`（例: ["UK1"]）が設定されていることを確認せよ。違反がある場合は警告として指摘せよ。

- **データ型と桁数:**
  - 全てのカラムの `typeAndSize` が、許可されたデータ型（`VARCHAR(N)`, `MEDIUMTEXT`, `TEXT`, `INTEGER`, `TINYINT`, `BIGINT`, `DECIMAL(P, S)`, `NUMERIC(P, S)`, `BOOLEAN`, `BOOL`, `TINYINT(1)`, `BIT`, `DATE`, `TIME`, `TIMESTAMP`, `DATETIME`, `JSON`, `JSONB`, `BYTEA`, `BLOB`, `ENUM`）のいずれかであることを確認せよ。但し、`ENUM`は Prisma 変換プロンプトで未対応のため、警告として指摘せよ。
  - `VARCHAR(N)` の場合、主キー/FK 項目は 36 桁以外の場合エラーとせよ。桁数が省略されていた場合、助言として指摘せよ。
  - `DECIMAL(P, S)` または `NUMERIC(P, S)` の場合、`P`（桁数）が `S`（精度）以上であることを確認せよ。
  - `REAL` や `FLOAT(N)` が使用されている場合、`DECIMAL(P, S)`に変更することを警告せよ。

#### 3. インデックス定義セクションの確認観点 (indexes)

- **命名規則:** 全ての `indexPhysicalName` が接頭辞`idx_`で始まっており、システム全体で一意であると見なせることを確認せよ。
- **カラム物理名とソート順の対応:**
  - インデックスタイプが`B-Tree`の場合、`sortOrder` が `null` ではないこと（`ASC`または`DESC`が設定されていること）を確認せよ。
  - `B-Tree`の場合、`columnPhysicalName` 配列の要素数と `sortOrder` 配列の要素数が一致することを確認せよ。
- **インデックスタイプとソート順の整合性:**
  - インデックスタイプが Hash の場合、`sortOrder` が `null` であることを確認せよ。
- **外部キー/UNIQUE キーのインデックス定義:**
  - `columns` 定義で `isForeignKey`: `true` のカラム、または複合 UNIQUE キーとして定義されているカラムセットが、`indexes` セクションで `B-Tree` インデックスとして定義されていることを確認せよ。RDBMS の自動作成を考慮し、未定義の場合は警告とする。
- **PK の重複定義回避:** `id` カラムのみを含むインデックスが、`indexes` 配列内に重複して定義されていないことを確認せよ。
- **検索項目に対するインデックス（助言）:** カラム名に name, email, url といった検索項目として指定されることが示唆される項目について、インデックスが定義されていない場合、助言として指摘せよ。

#### 4. 外部キー定義セクションの確認観点 (foreignKeys)

- **命名規則:** 全ての `foreignKeyPhysicalName` が接頭辞`fk_`で始まっており、システム全体で一意であると見なせることを確認せよ。
- **カラム定義との相互参照:**
  - `columns` 定義で `isForeignKey`: `true` となっている全てのカラムが、`foreignKeys` 配列内で `sourceColumnPhysicalName` として記載されていることを確認せよ。
- **参照先テーブル/カラムの整合性:**
  - `targetTablePhysicalName` が `tableList` に存在することを確認せよ。
  - `targetColumnPhysicalName` の記載が "id" であることを確認せよ。違反がある場合は警告として指摘せよ。
- **ON DELETE / ON UPDATE:** `onDelete` および `onUpdate` が、`Cascade`、`Restrict`、`NoAction`、`SetNull`、`SetDefault` のいずれかで明記されていることを確認せよ。

## 出力形式

以上のレビューで抽出した指摘を、設計書ごとに下記のフォーマットで出力せよ。レビュー対象がテーブル一覧全体に関する指摘の場合（セクション 2）は、{テーブル論理名} に「テーブル一覧」、{テーブル物理名} に「tables」を適用せよ。

受領側でスクリプト処理を行い、セパレーター(`------`)で分割して、そのままレビュー記録票として用いる。このため、セパレーター・ファイル名・指摘内容以外の内容を含めてはならない。「レビュワー確認事項」セクションはヒューマンチェック結果を記載する想定のため、セクション名と定型メッセージのみ出力せよ。

フォーマット内の下記のプレースホルダーは、下記のとおり実際の項目名に読み替えよ。

- **{テーブル論理名}** レビュー対象としたテーブル定義書のテーブル論理名。テーブル一覧の場合は「テーブル一覧」。
- **{テーブル物理名}** レビュー対象としたテーブル定義書のテーブル物理名。テーブル一覧の場合は「tables」。
- **{レビュー日時}** レビューを実施した日時を、日本時間の`YYYY/MM/DD HH:mm:SS`形式で表記する。
- **{NO}** 各セクションごとに纏めた指摘一覧の通し番号。セクションごとに 1 オリジンで採番せよ。
- **{指摘結果}** 下記のいずれかを表記する。
  - **-** ファイル整合性チェック違反のためレビューを中止した項目である場合。
  - **エラー** レビュー観点に明確に違反しており、修正が必須である場合。
  - **警告** レビュー観点で「警告として指摘せよ」としているチェック項目に違反している場合。
  - **OK** レビュー観点違反が検出されなかった場合。
  - **助言** レビュー観点違反は検出されなかったが、改善の余地がある場合。(例: 電話/電話番号 の表記ゆれ等)
- **{項目名}** 検査対象とした DB 項目の名称。
- **{指摘内容}** 検査対象とした項目への、短い文章による指摘。(例: 「指摘なし」「設定されていません」「項目に定義可能な型ではありません」「参照先のテーブルが定義されていません」など)
- **{自由記述}** 当該指摘項目に対する、文章による自由記述形式の備考。修正方針に対する助言等。
- **{レビュワー確認}** ヒューマンフィードバックのテンプレートとして、「指摘結果」に応じて下記のいずれかを表記する。
  - **エラー** 「修正してください」と表記する。
  - **警告** 「**■ 検討結果を記載してください ■**」と表記する。
  - **OK** 「-」と表記する。
  - **助言** 「**■ 検討結果を記載してください ■**」と表記する。

以下のセクションは、レビュー対象の設計書に合わせて出力を調整せよ。

- **### テーブル一覧** テーブル個別定義書のレビュー結果の場合、当該テーブルに関する内容のみ記載する。
- **### テーブル個別定義書** テーブル一覧のレビュー結果の場合、省略する。
- **## 2. テーブル一覧チェック結果** テーブル個別定義書のレビュー結果の場合、当該テーブルに関する内容のみ記載する。
- **## 3. テーブル個別定義書チェック結果** テーブル一覧のレビュー結果の場合、省略する。

```text
------
{テーブル物理名}_review.md
------
# {テーブル論理名}設計書レビュー記録票

- レビュー日時 {レビュー日時}

## 1. JSON構造とデータ整合性チェック結果

### テーブル一覧

| No | 項目名 | 指摘結果 | 指摘内容 | 備考 | レビュワー確認 |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

### テーブル個別定義書

| No | 項目名 | 指摘結果 | 指摘内容 | 備考 | レビュワー確認 |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

## 2. テーブル一覧チェック結果

| No | 項目名 | 指摘結果 | 指摘内容 | 備考 | レビュワー確認 |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

## 3. テーブル個別定義書チェック結果

### 1. 概要セクションチェック結果

| No | 項目名 | 指摘結果 | 指摘内容 | 備考 | レビュワー確認 |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

### 2. カラム定義セクションチェック結果

| No | 項目名 | 指摘結果 | 指摘内容 | 備考 | レビュワー確認 |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

### 3. インデックス定義セクションチェック結果

| No | 項目名 | 指摘結果 | 指摘内容 | 備考 | レビュワー確認 |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

### 4. 外部キー定義セクションチェック結果

| No | 項目名 | 指摘結果 | 指摘内容 | 備考 | レビュワー確認 |
| ---- | -------- | ---------- | ---------- | ---------- | ---------------- |
| {NO} | {項目名} | {指摘結果} | {指摘内容} | {自由記述} | {レビュワー確認} |

## レビュワー確認事項

**必ず記入してレビュー記録票として提出してください。**
------
```

{DB_JSON}
