# API設計書をJSONに変換する

このプロンプトは、マークダウンで記載されたAPI覧とAPI個別設計書をJSONに変換することを目的とする。

下記のAPI一覧とテーブル個別設計書群を構造的なマークダウンとして解析し、JSONファイルに変換せよ。作成したJSONファイルは、AIによる自動レビューのインプットや、NestJSスケルトンコード作成のインプットとする前提である。

## API一覧の構成

### 1. API一覧のJSON変換

API一覧は、マークダウンの表形式で記述されている。記述内容を下記の構造を持つオブジェクトの配列に変換せよ。配列のキーは`apiList`とせよ。

| 項目             | 変換後のキー名 |
| ---------------- | -------------- |
| No               | no             |
| API名            | name           |
| ファイルパス     | path           |
| エンドポイント   | endpoint       |
| リソース         | resource       |
| アクション       | action         |
| メソッド         | method         |
| ビジネスドメイン | category       |
| 認証要否         | authRequired   |
| 備考             | note           |

- API名は、[API名](filepath)の形式で記載されている。下記のとおり抽出し、JSONの項目値とせよ。
  - API名項目から、Markdownリンクの**リンクテキスト部分: [ ]内**を抽出し、nameキーの値とせよ。
  - Markdownリンクの**URL部分: ( )内**を抽出し、pathキーの値とせよ。
  - [API名](filepath)形式でなかった場合は、記載内容をそのまま文字列として`name`の要素とし、`path`は""(空文字)とせよ。また、[WARN]としてログに記録せよ。
  - [API名](filepath)形式で、かつ、各項目が抽出できなかった場合は、その要素を""(空文字)とし、[WARN]としてログに記録せよ。

- リソース・アクション・メソッドは、空欄もしくは`-`の場合、[ERROR]としてログに記録せよ。

- メソッドは、設定値に応じて`"GET"` `"POST"` `"PATCH"` `"PUT"` `"DELETE"`のいずれかとせよ。それ以外の値が設定されている場合、[ERROR]としてログに記録せよ。

- 認証要否は、「要」の場合`true`、「不要」の場合`false`とせよ。それ以外の値が設定されている場合、[ERROR]としてログに記録せよ。

- 備考は、空欄もしくは`-`の場合、""(空文字)とせよ。それ以外の場合は設定値を文字列として取得し、noteキーの値とせよ。

- 上記以外の項目は、文字列として取得し、各キーの値とせよ。

- 項目に欠落がある場合、当該項目を""(空文字)で補完し、[ERROR]としてログに記載せよ。

## API個別設計書の構成

API個別設計書は下記の4セクションで構成される。それぞれのセクションを分析し、記述内容をJSON形式に変換せよ。

1. API概要
2. リクエストヘッダ
3. リクエスト(リクエストボディ、パスパラメータ、URLパラメータ)
4. 処理概要
5. レスポンス
6. エラー定義

### 1. API概要のJSON変換

API概要は、マークダウンの表形式(実質的に箇条書き)で記述されている。記述内容を下記のオブジェクトに変換せよ。各キー値の設定方法は「API一覧のJSON変換」と同じである。なお、個別設計書においては、API名にリンクは含まれない。オブジェクトのキーは`summary`とせよ。

| 項目             | 変換後のキー名 |
| ---------------- | -------------- |
| API名            | name           |
| エンドポイント   | endpoint       |
| リソース         | resource       |
| アクション       | action         |
| メソッド         | method         |
| ビジネスドメイン | category       |
| 認証要否         | authRequired   |
| データ形式       | dataType       |

「備考」欄の記載は自動レビューやスケルトンコード作成に直接寄与しないため、取得不要である。また、上記6項目に欠落がある場合、""(空文字)で補完し、[ERROR]としてログに記録せよ。

### 2. リクエストヘッダのJSON変換

リクエストヘッダは、マークダウンの表形式で記述されている。記述内容を下記の構造を持つオブジェクトの配列に変換せよ。オブジェクトのキーは`requestHeader`とせよ。なお、リクエストヘッダの記載がない場合は`[]`(空配列)とせよ。

| 項目   | 変換後のキー名 |
| ------ | -------------- |
| 項目名 | name           |
| 必須   | required       |
| 値の例 | sample         |
| 備考   | note           |

- 必須欄は、「必須」は`true`、「任意」または`-`または空欄は`false`とせよ。それ以外の場合は[ERROR]としてログに記録せよ。
- 値の例と備考欄は、空欄もしくは`-`の場合は""(空文字)で、それ以外の場合は記載内容をそのまま出力せよ。
- 項目に欠落がある場合、当該項目を""(空文字)で補完し、[ERROR]としてログに記載せよ。

### 3. リクエストのJSON変換

リクエストは、マークダウンの表形式で記載されている。リクエスト(リクエストボディ)は、Markdownのヘッダー(例: ### ルートオブジェクト(リクエスト)、#### 注文明細)とそれに続く表形式で記載されている。このヘッダーレベルによる階層構造を保持したJSONオブジェクトに再帰的に変換せよ。

オブジェクトのキーは`requestBody`とせよ。リクエストボディの記載がない場合(またはリクエストボディがないAPIの場合)は空配列`[]`とせよ。

#### 変換スキーマの定義

変換後のJSONオブジェクトは、以下のプロパティを持つ再帰的な構造とする。

| 変換前の項目     | 変換後のキー名 | データ型      | 備考(ロジックの解釈)                                                   |
| ---------------- | -------------- | ------------- | ---------------------------------------------------------------------- |
| 論理名           | description    | string        |                                                                        |
| 物理名           | name           | string        |                                                                        |
| 型               | type           | string        | 例: string, number, integer, boolean, array, date, object              |
| DBテーブル       | dbTable        | string        |                                                                        |
| DBカラム         | dbColumn       | string        |                                                                        |
| 必須             | required       | boolean       |                                                                        |
| 最小桁数         | minLength      | number        | `type`が`string`の場合にのみ適用される文字数制限                       |
| 最大桁数         | maxLength      | number        | `type`が`string`の場合にのみ適用される文字数制限                       |
| フォーマット     | format         | string        |                                                                        |
| 最小値           | min            | number / date | `type`が数値型の場合は数値の最小値。`type`が`date`の場合は日付の最小値 |
| 最大値           | max            | number / date | `type`が数値型の場合は数値の最大値。`type`が`date`の場合は日付の最大値 |
| 備考             | note           | string        |                                                                        |
| 子要素(再帰構造) | children       | array         |                                                                        |

- 「子要素」以外の項目に欠落がある場合、当該項目を""(空文字)で補完し、[ERROR]としてログに記載せよ。

#### 変換ロジック(階層構造の再現)

- **ルート要素の特定:**

  - `###ヘッダー`(例: `### ルートオブジェクト(リクエスト)`)に続く表形式の内容が、JSONオブジェクトのルートレベルのプロパティの配列となる。

- **子要素(ネスト)の特定:**

  - 親となる項目(例: items)の型が`object`または`array`であり、かつ、その次に続く表がヘッダーレベルが一つ深い項目(例: `#### 注文明細`)に属する場合、その表の全項目は親項目(items)の`children`配列の要素として再帰的にネストされる。
  - 子要素のセクション名は、親となる項目の論理名で定義されている前提とせよ。(例: `#### 注文明細`)
  - `children`キーは、その項目に子要素が存在しない場合は省略せよ。
  - 当該項目の型が`object` `array`以外で、かつ`children`キーが定義されている場合は[ERROR]としてログに記録せよ。
  - 当該項目の型が`object` `array`で、かつ子要素の定義(例: `### 注文`に対する`#### 注文明細`)が定義されていない場合、[ERROR]としてログに記録せよ。

- **値の変換:**
  - **必須:** 「必須」は`true`、「任意」または`-`または空欄は`false`とせよ。それ以外の場合は[ERROR]としてログに記録せよ。
  - **DBテーブル/DBカラム:**
    - 空欄または`-`の場合は""(空文字)とせよ。
    - DBテーブルが`Y/N`で記載されている場合は、「対応するDBテーブル有り」の誤解である可能性を考慮し、[WARN]としてログに記録せよ。
    - DBテーブルが空欄または`-`で、DBカラムに具体的な記載がある場合は、[ERROR]としてログに記録せよ。
    - それ以上の詳細なチェックは、後続レビューの責務であるため、本プロンプトでは対応しない。
  - **最小桁数/最大桁数:**
    - 0以上の整数として解釈できる場合は数値型で出力せよ。
    - 空欄または`-`の場合は、`null`とせよ。非数値文字列の場合は`null`とし、[ERROR]としてログに記録せよ。
    - `type`が`string`以外の項目に対して、空欄または`-`以外の値が設定されている場合は`null`とし、[ERROR]としてログに記録せよ。
    - 最大桁数・最小桁数が`null`以外の設定値となり、かつ、最大桁数の設定が最小桁数の設定未満となる場合、[ERROR]としてログに記録せよ。
  - **最大値/最小値:**
    - `type`が数値型の場合、値が数値として解釈できる場合はnumber型で出力せよ。`-`の場合は、`null`とせよ。非数値文字列の場合は`null`とし、[ERROR]としてログに記録せよ。
    - `type`が`date`の場合、値が日付文字列として解釈できる場合 (例: `YYYY-MM-DD`形式) はstring型でそのまま出力せよ。日付文字列ではない場合は`null`とし、[ERROR]としてログに記録せよ。この値は後続ステップで`@MinDate` / `@MaxDate`の引数として利用される前提である。
    - `type`が`array`の場合、配列長の制限と解釈し、0以上の整数として解釈できる場合はnumber型で出力せよ。`-`の場合は、`null`とせよ。0以上の整数として解釈できない場合は`null`とし、[ERROR]としてログに記録せよ。
    - `type`が上記以外の場合、値が空欄または`-`の場合は、`null`とせよ。空欄・`-`以外の場合は`null`とし、[ERROR]としてログに記録せよ。
    - 最大値・最小値が`null`以外の設定値となり、かつ、最大値の設定が最小値の設定未満となる場合、[ERROR]としてログに記録せよ。
  - **空欄処理:** フォーマット、備考が空欄または`-`の場合は、""(空文字)とせよ。

- **エラー:** 必須項目(物理名、論理名、型、必須)のいずれかが欠落している場合は、[ERROR]としてログに記録せよ。

- **ネストの深さに対する助言:**
  - ネストの深さ(ルートレベルを1段目とする)が4段目に到達した場合、[ADVICE]としてログに記録せよ。
  - ネストの深さが5段目以上に到達した場合、[WARN]としてログに記録せよ。
  - 助言メッセージの例:
    - [ADVICE]：項目 "{物理名}" はネストが4段目に到達しています。データ構造の複雑性、テーブル結合および実装コードの可読性に影響を及ぼす可能性があるため、設計の分割(別API化)を検討することを推奨します。
    - [WARN]：項目 "{物理名}" はネストが5段以上に到達しており、極端な複雑性を示しています。即座に設計を見直し、構造をフラット化することを強く推奨します。

#### `list`型取得APIのパラメータに関する助言

- 取得系APIで、かつエンドポイントが`list`の場合かつ、下記のページングパラメータがリクエストに定義されていない場合、追加することを[ADVICE]としてログに記録せよ。

| 論理名     | 物理名    | 型     | DBテーブル | DBカラム | 必須 | 最小桁数 | 最大桁数 | フォーマット | 最小値 | 最大値 | 備考 |
| ---------- | --------- | ------ | ---------- | -------- | ---- | -------- | -------- | ------------ | ------ | ------ | ---- |
| 取得件数   | limit     | number | -          | -        | 任意 | -        | -        | -            | 1      | 100    | -    |
| オフセット | offset    | number | -          | -        | 任意 | -        | -        | -            | 0      | -      | -    |
| ソートキー | sortBy    | string | -          | -        | 任意 | -        | -        | -            | -      | -      | -    |
| ソート順   | sortOrder | string | -          | -        | 任意 | -        | -        | asc/desc     | -      | -      | -    |

#### パスパラメータ及びURLパラメータのJSON変換

- `### パスパラメータ`セクションをキー`pathParameters`とするオブジェクト配列として、`### URLパラメータ`セクションをキー`urlParameters`とするオブジェクト配列として、リクエストボディ同様に解釈せよ。
- パスパラメータとURLパラメータは配列のインデックス順に与えられるものとし、パラメータを入れ子にしてはならない(違反がある場合は[ERROR]としてログに記録せよ)。
- エンドポイント定義のパスパラメータ定義`{parameterName}`の件数・物理名・並び順と、「リクエスト」セクションのパスパラメータ定義の件数・物理名・並び順が一致するかどうかを確認し、一致しない場合は[ERROR]としてログに記録せよ。
- エンドポイント定義のURLパラメータ定義`{parameterName: type}`の件数・物理名・型と、「リクエスト」セクションのURLパラメータ定義の件数・物理名・型が一致するかどうかを確認し、一致しない場合は[ERROR]としてログに記録せよ。

#### パスパラメータのテーブルIDについて

- DB操作を前提とする場合、対象テーブルはエンドポイント定義・リソース定義で自明であり、検索キーはサロゲートキーのみが与えられている前提である。このため、DBテーブル/DBカラムが空欄あるいは`-`の場合は[WARN]としてログに記録せよ。

### 4. 処理概要のJSON変換

処理概要は、自由記述形式のテキストで記載されている。記載内容をJSON文字列として正しくエスケープし、Markdownの改行(`LF`/`CRLF`)はJSON文字列内の改行シーケンス(`\n`)に変換した上で文字列として出力せよ。文字列のキーは`description`とせよ。但し、処理概要はあくまでエンドポイントの仕様記述に留めるため、100文字を超える場合(特に、トランザクションの内容にまで言及されている場合)は[WARN]としてログに記録せよ。

処理概要が存在しない場合、""(空文字)で補完し、[ERROR]としてログに記録せよ。

### 5. レスポンスのJSON変換

レスポンスは、レスポンスコード及びレスポンス(マークダウンの表形式もしくは「なし」)で記載されている。記載内容を下記の構造を持つオブジェクトに変換せよ。オブジェクトのキーは`response`とし、レスポンスコード、レスポンスをそれぞれ子項目とせよ。

#### レスポンスコード

- キーを`status`として、HTTPステータスコードの数値部分を数値型として記載せよ。(例: `200 OK` → `200`)
  - 但し、ステータスコードの数値と慣用句の一般的な組み合わせが一致しない場合場合、[ERROR]としてログに記録せよ。(例: `200 NO CONTENT`)
- レスポンスコードが存在しない場合、`null`で補完し、[ERROR]としてログに記載せよ。

#### レスポンス

- キーを`body`として、階層構造を持つオブジェクト形式で記載せよ。階層構造の表現方法及び欠落時の補完方法は、「リクエストのJSON変換」と同じである。
  - 但し、「必須」「最小桁数」「最大桁数」「フォーマット」「最小値」「最大値」はレスポンス項目には存在しないため、省略せよ。
  - レスポンスが「なし」の場合、空配列`[]`で記載せよ。

#### `list`型取得APIのレスポンス項目に関する助言

- 取得系APIで、かつエンドポイントが`list`の場合かつ、下記のページングパラメータがレスポンスに定義されていない場合、追加することを[ADVICE]としてログに記録せよ。

| 論理名     | 物理名      | 型     | DBテーブル | DBカラム | 備考 |
| ---------- | ----------- | ------ | ---------- | -------- | ---- |
| 総件数     | totalCount  | number | -          | -        | -    |
| 取得件数   | limit       | number | -          | -        | -    |
| オフセット | offset      | number | -          | -        | -    |
| 総ページ数 | totalPages  | number | -          | -        | -    |
| 現在ページ | currentPage | number | -          | -        | -    |

### 6. エラー定義のJSON変換

エラー定義は、マークダウンの表形式で記述されている。記述内容を下記の構造を持つオブジェクトの配列に変換せよ。オブジェクトのキーは`errors`とせよ。

| 項目                       | 変換後のキー名 |
| -------------------------- | -------------- |
| HTTPステータスコード       | status         |
| エラーメッセージ(必須)     | message        |
| エラーメッセージ詳細(任意) | detail         |
| 発生条件                   | description    |

- HTTPステータスコードは、コードの数字部分のみを数値型で記載せよ。
  - 但し、ステータスコードの数値と慣用句の一般的な組み合わせが一致しない場合(例: `400 UNAUTHORIZED`など)は、[ERROR]としてログに記録せよ。
  - HTTPステータスコードが空欄もしくは`-`の場合は、[ERROR]としてログに記録せよ。
- エラーメッセージ(必須)が空欄もしくは`-`の場合は、[ERROR]としてログに記録せよ。
- エラーメッセージ詳細(任意)及び発生条件が空欄もしくは`-`の場合は""(空文字)で、それ以外の場合は記載内容をそのまま出力せよ。
- 項目に欠落がある場合、当該項目を""(空文字)で補完し、[ERROR]としてログに記載せよ。

## 出力

API一覧及びAPI個別設計書群の処理結果を統合し、下記のフォーマットのJSONファイルとして出力せよ。"{}"は、取得した実際の文字列・設定値で読み替えるためのプレースホルダである。

なお、API個別設計書群の配列(`apis`)は、リソース名をキーにした配列の集合として記載し、各配列内では、API一覧のNo順にソートせよ。`apis`配下の項目`no`は、API一覧の対応する`no`の設定値を割り当てよ。

```JSON
{
  "apiList": [
    {
      "no": "{API_NO}",
      "name": "{API_NAME_LINK_TEXT}",
      "path": "{API_FILE_PATH}",
      "endpoint": "{API_ENDPOINT}",
      "resource": "{API_RESOURCE}",
      "action": "{API_ACTION}",
      "method": "{API_METHOD}",
      "category": "{API_BUSINESS_DOMAIN}",
      "authRequired": {AUTH_REQUIRED_BOOLEAN},
      "note": "{API_LIST_NOTE}"
    }
  ],
  "apis": [
    "{API_RESOURCE}": [
      {
        "no": "{API_NO}",
        "summary": {
          "name": "{API_NAME_TEXT}",
          "endpoint": "{API_ENDPOINT}",
          "resource": "{API_RESOURCE}",
          "action": "{API_ACTION}",
          "method": "{API_METHOD}",
          "category": "{API_BUSINESS_DOMAIN}",
          "authRequired": {AUTH_REQUIRED_BOOLEAN},
          "dataType": "{API_DATA_TYPE}"
        },
        "requestHeader": [
          {
            "name": "{HEADER_NAME}",
            "required": {HEADER_REQUIRED_BOOLEAN},
            "sample": "{HEADER_SAMPLE_VALUE}",
            "note": "{HEADER_NOTE}"
          }
        ],
        "pathParameters": [
          {
            "description": "{論理名}",
            "name": "{物理名}",
            "type": "{型}",
            "dbTable": "{DBテーブル}",
            "dbColumn": "{DBカラム}",
            "required": {REQUIRED_BOOLEAN},
            "minLength": {MIN_LENGTH_NUMBER_OR_NULL},
            "maxLength": {MAX_LENGTH_NUMBER_OR_NULL},
            "format": "{フォーマット}",
            "min": {MIN_VALUE_NUMBER_DATE_OR_NULL},
            "max": {MAX_VALUE_NUMBER_DATE_OR_NULL},
            "note": "{備考}"
          }
        ],
        "urlParameters": [
          {
            "description": "{論理名}",
            "name": "{物理名}",
            "type": "{型}",
            "dbTable": "{DBテーブル}",
            "dbColumn": "{DBカラム}",
            "required": {REQUIRED_BOOLEAN},
            "minLength": {MIN_LENGTH_NUMBER_OR_NULL},
            "maxLength": {MAX_LENGTH_NUMBER_OR_NULL},
            "format": "{フォーマット}",
            "min": {MIN_VALUE_NUMBER_DATE_OR_NULL},
            "max": {MAX_VALUE_NUMBER_DATE_OR_NULL},
            "note": "{備考}"
          }
        ],
        "requestBody": [
          {
            "description": "{論理名}",
            "name": "{物理名}",
            "type": "{型}",
            "dbTable": "{DBテーブル}",
            "dbColumn": "{DBカラム}",
            "required": {REQUIRED_BOOLEAN},
            "minLength": {MIN_LENGTH_NUMBER_OR_NULL},
            "maxLength": {MAX_LENGTH_NUMBER_OR_NULL},
            "format": "{フォーマット}",
            "min": {MIN_VALUE_NUMBER_DATE_OR_NULL},
            "max": {MAX_VALUE_NUMBER_DATE_OR_NULL},
            "note": "{備考}",
            "children": []
          }
        ],
        "description": "{処理概要_TEXT}",
        "response": {
          "status": {RESPONSE_STATUS_NUMBER},
          "body": [
            {
              "description": "{論理名}",
              "name": "{物理名}",
              "type": "{型}",
              "dbTable": "{DBテーブル}",
              "dbColumn": "{DBカラム}",
              "note": "{備考}",
              "children": []
            }
          ]
        },
        "errors": [
          {
            "status": {ERROR_STATUS_NUMBER},
            "message": "{ERROR_MESSAGE_REQUIRED}",
            "detail": "{ERROR_MESSAGE_DETAIL_OR_EMPTY}",
            "description": "{ERROR_OCCURRENCE_CONDITION_OR_EMPTY}"
          }
        ]
      },      
    ],
  ]
}
```

出力内容は、下記のフォーマットで返却せよ。受領側でスクリプト処理を行い、セパレーター(`------`)で分割して、そのまま計算機で処理するためのインプットとして用いる。このため、セパレーター・ファイル名・JSON・ログ以外の内容を含めてはならない。

また、ログは指摘のレベルに応じて、行頭に[ERROR]あるいは[WARN]のプレフィックスを付与せよ。

```text
------
api.json
------
JSON出力内容
------
generate.log
------
ログ内容
------
```

## API設計書

{API_LIST}

{API_DOCUMENTS}
